#pragma once

#include <cstddef>
#include <vector>

/*
 * 文件概述
 * --------
 * 该头文件声明了若干用于性能分析（perf 入门示例）的“热点”函数。
 * 这些函数具备明确的性能特征：
 *  - 朴素矩阵乘法：三重循环、缓存局部性较差，典型 CPU 热点；
 *  - 分支密集求和：分支预测可能失效，展示控制流对性能的影响；
 *  - 浮点忙循环：生成稳定的计算热点与可读符号，便于采样与报告。
 *
 * 使用场景
 * --------
 * 在 WSL/Ubuntu 环境下，通过 `perf record/report/top` 对这些函数进行采样，
 * 观察调用栈与热点分布，建立对性能分析工具的基本直觉。
 *
 * 约定说明
 * --------
 * - 接口均为 C++17，可在 CMake 中以 `target_compile_features(cxx_std_17)` 启用。
 * - 返回值中包含“校验/汇总”以避免编译器把计算优化掉（即便在 -O2 及以上）。
 */

namespace mycore {

/**
 * 朴素的 NxN 矩阵乘法（O(N^3)），重复执行 `iters` 次。
 *
 * 参数
 * ----
 * - N：矩阵阶数（行列数）。
 * - iters：重复计算的次数，用于拉长运行时间，便于采样。
 *
 * 返回
 * ----
 * - double：结果矩阵元素求和的校验值，用于防止被优化移除。
 *
 * 性能特征
 * --------
 * - 三重循环导致大量乘加与访存，缓存命中率较低，容易成为主要热点；
 * - 可在 `perf report` 中看到内层循环与相关符号占比高。
 */
double matmul_naive(int N, int iters);

/**
 * 分支密集的加权求和，用于展示分支预测对性能的影响。
 *
 * 参数
 * ----
 * - data：输入整型数据序列。
 * - mod：取模参数；若为 0，将跳过第一条“能被 mod 整除”的分支路径。
 *
 * 返回
 * ----
 * - long long：累加结果。
 *
 * 性能特征
 * --------
 * - 数据分布与分支条件耦合时，分支预测可能频繁失效，形成热点；
 * - 适合与非分支版本（如条件转算术）对比，观察 IPC 变化与热点迁移。
 */
long long sum_with_branch(const std::vector<int>& data, int mod);

/**
 * 浮点忙循环，生成稳定的计算负载与符号，便于 perf 采样与演示。
 *
 * 参数
 * ----
 * - iterations：循环迭代次数（越大运行时间越长）。
 *
 * 返回
 * ----
 * - 无返回值。
 *
 * 说明
 * ----
 * - 实现中使用 `volatile` 汇聚变量防止编译器优化掉计算；
 * - 适用于 `perf top` 的实时观察，或 `perf record` 的离线报告。
 */
void burn_cpu(std::size_t iterations);

}  // namespace mycore