# 独占任务功能测试指南

## 功能说明
当一个需求被某人接取后，其他人的申请会自动被取消，确保一个需求只能被一个人接取。

## 修改内容

### 1. 云函数修改 (`cloudfunctions/task/index.js`)

#### approveTaskApplication 函数增强：
- 当批准一个申请时，自动查找同一个需求的其他待处理申请
- 将其他申请状态设置为 `cancelled`
- 添加取消原因：`该需求已被其他用户接取`
- 发送取消通知给被取消的申请者

#### sendTaskApprovalNotification 函数增强：
- 支持取消原因参数
- 区分拒绝和取消的通知内容

### 2. 前端支持
- 任务列表页面已支持 `cancelled` 状态显示
- 状态文本映射：`cancelled` -> `已取消`

## 测试步骤

### 准备工作
1. 部署修改后的云函数到微信云开发环境
2. 准备至少3个测试账号：
   - 账号A：需求发布者
   - 账号B：申请者1
   - 账号C：申请者2

### 测试流程

#### 步骤1：发布需求
1. 使用账号A登录小程序
2. 发布一个新需求（如"帮忙取快递"）

#### 步骤2：多人申请
1. 使用账号B登录，申请该需求
2. 使用账号C登录，申请同一个需求
3. 确认两个申请都显示为"待确认"状态

#### 步骤3：批准其中一个申请
1. 使用账号A登录
2. 进入"任务申请管理"页面
3. 批准账号B的申请

#### 步骤4：验证结果
1. **账号A（发布者）**：
   - 确认申请管理页面只显示已批准的申请
   - 其他申请应该消失或显示为已取消

2. **账号B（被批准者）**：
   - 在"我的任务"中看到新创建的任务
   - 收到"任务申请已通过"的通知

3. **账号C（被取消者）**：
   - 在"我的任务"中看到申请状态变为"已取消"
   - 收到"任务申请已取消：该需求已被其他用户接取"的通知

### 预期结果
- ✅ 只有一个申请被批准并创建任务
- ✅ 其他申请自动取消
- ✅ 所有相关用户收到正确的通知
- ✅ 数据库中申请记录状态正确更新

## 数据库验证

### task_applications 集合
检查同一个 `demandId` 的申请记录：
- 被批准的申请：`status: 'approved'`, `taskId: 'xxx'`
- 被取消的申请：`status: 'cancelled'`, `cancelReason: '该需求已被其他用户接取'`

### tasks 集合
- 只应该创建一个任务记录
- 任务的 `assigneeId` 应该是被批准申请者的 openid

### messages 集合
- 被批准者收到通过通知
- 被取消者收到取消通知，包含取消原因

## 注意事项
1. 确保云函数部署成功
2. 测试时注意清理之前的测试数据
3. 如果遇到问题，检查云函数日志
4. 确保所有测试账号都有正确的用户信息