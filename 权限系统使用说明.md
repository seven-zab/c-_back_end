# 权限系统使用说明

## 系统概述

本权限系统为校企助手小程序提供了完整的用户权限管理功能，支持不同角色的用户申请和管理权限。

## 权限等级

系统定义了以下权限等级：

- **0 - 普通用户**：默认权限，可以浏览内容
- **1 - 管理员**：最高权限，可以审核所有权限申请
- **2 - 地方村委**：可以发布需求、审核权限申请
- **3 - 学校**：可以发布需求、接取任务
- **4 - 果农**：可以接取任务、打印报告

## 功能特性

### 1. 权限申请
- 用户可以在个人中心申请不同的权限等级
- 需要填写申请理由
- 支持选择申请的权限类型

### 2. 权限审核
- 管理员和村委可以审核权限申请
- 支持通过或拒绝申请
- 自动发送审核结果通知

### 3. 权限管理
- 实时显示用户当前权限等级
- 管理员可以查看所有待审核申请
- 支持权限申请历史记录

## 云函数说明

### permission 云函数
主要的权限管理云函数，包含以下功能：
- `getUserPermission`: 获取用户权限信息
- `setUserPermission`: 设置用户权限（管理员专用）
- `applyPermission`: 申请权限
- `getPermissionApplications`: 获取权限申请列表
- `reviewPermissionApplication`: 审核权限申请
- `initAdminUser`: 初始化管理员用户

### initAdmin 云函数
用于初始化管理员用户权限的专用云函数。

### initDatabase 云函数
已更新以支持权限相关的数据库集合。

## 页面说明

### 个人中心页面 (pages/mine/mine)
- 显示当前用户权限等级
- 提供权限申请入口
- 管理员可以看到权限申请管理入口

### 权限申请管理页面 (pages/permission-management/permission-management)
- 仅管理员和村委可访问
- 显示所有权限申请
- 支持审核操作

### 权限系统测试页面 (pages/test-permission/test-permission)
- 用于测试权限系统各项功能
- 包含完整的功能测试流程

## 部署步骤

1. 运行 `deploy-permission-functions.bat` 安装依赖
2. 在微信开发者工具中上传云函数：
   - cloudfunctions/permission
   - cloudfunctions/initAdmin
   - cloudfunctions/initDatabase
3. 运行 initDatabase 云函数初始化数据库
4. 运行 initAdmin 云函数设置管理员权限

## 测试流程

1. 进入"个人中心" -> "权限系统测试"
2. 系统会自动运行以下测试：
   - 初始化管理员用户
   - 获取用户权限
   - 申请权限
   - 获取权限申请列表
   - 审核权限申请

## 注意事项

1. 管理员用户的 openid 在 initAdmin 云函数中硬编码为 `oqy9105fqmCXnCzV2K3G011`
2. 权限申请需要管理员或村委审核才能生效
3. 系统会自动发送权限申请和审核结果的通知消息
4. 所有权限操作都会记录在数据库中，便于追踪和管理

## 数据库结构

### users 集合
```javascript
{
  _id: "用户ID",
  openid: "微信openid",
  permission: 0, // 权限等级
  nickName: "用户昵称",
  avatarUrl: "头像URL",
  // ... 其他用户信息
}
```

### permission_applications 集合
```javascript
{
  _id: "申请ID",
  openid: "申请用户openid",
  requestedPermission: 4, // 申请的权限等级
  reason: "申请理由",
  status: "pending", // pending/approved/rejected
  createdAt: "申请时间",
  reviewedAt: "审核时间",
  reviewedBy: "审核人openid",
  userInfo: {
    nickName: "用户昵称",
    avatarUrl: "头像URL"
  }
}
```